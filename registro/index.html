<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Empresa</title>
  <link rel="stylesheet" href="../css/main.css">
</head>

<body>
  <div class="main">
    <h1>Registrar Empresa</h1>

    <form id="registroEmpresa">
      <input type="text" id="nombre_comercial" placeholder="Nombre comercial" required>
      <input type="text" id="razon_social" placeholder="Raz√≥n social" required>
      <input type="text" id="nit" placeholder="NIT" required>
      <input type="email" id="correo_empresa" placeholder="Correo de la empresa" required>

      <button type="submit">
        Enviar c√≥digo de verificaci√≥n
      </button>
    </form>

    <div id="verificacion" style="display:none; margin-top:16px;">
      <input type="text" id="codigo" placeholder="C√≥digo recibido por correo">
      <button id="verificarCodigo">Verificar c√≥digo</button>
    </div>

    <button id="continuar" style="display:none; margin-top:16px;">
      Continuar registro
    </button>

    <div id="status"></div>
  </div>

  <script type="module">
    const form = document.getElementById("registroEmpresa");
    const status = document.getElementById("status");
    const verificacion = document.getElementById("verificacion");
    const continuarBtn = document.getElementById("continuar");

    let datosEmpresa = null;
    let codigoValidado = false;

    // 1Ô∏è‚É£ Enviar c√≥digo
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.innerText = "Enviando c√≥digo...";

      datosEmpresa = {
        nombre_comercial: nombre_comercial.value,
        razon_social: razon_social.value,
        nit: nit.value,
        correo_empresa: correo_empresa.value
      };

      const res = await fetch(
        "https://n8n.globalnexoshop.com/webhook/crear_codigo_verificacion",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datosEmpresa)
        }
      );

      const data = await res.json();

      if (data.ok) {
        status.innerText = "C√≥digo enviado. Revisa tu correo.";
        verificacion.style.display = "block";
        form.querySelectorAll("input").forEach(i => i.disabled = true);
      } else {
        status.innerText = data.error || "Error enviando el c√≥digo";
      }
    });

    // 2Ô∏è‚É£ Verificar c√≥digo
    document.getElementById("verificarCodigo").addEventListener("click", async () => {
      status.innerText = "Verificando c√≥digo...";

      const res = await fetch(
        "https://n8n.globalnexoshop.com/webhook/verificar_codigo",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            correo_empresa: datosEmpresa.correo_empresa,
            codigo: codigo.value
          })
        }
      );

      const data = await res.json();

      if (data.ok) {
        codigoValidado = true;
        status.innerText = "Correo verificado correctamente ‚úÖ";
        continuarBtn.style.display = "block";
        verificacion.style.display = "none";
      } else {
        status.innerText = data.error || "C√≥digo inv√°lido o expirado";
      }
    });

    // 3Ô∏è‚É£ Continuar ‚Üí registrar empresa
    continuarBtn.addEventListener("click", async () => {
      if (!codigoValidado) {
        status.innerText = "Debes verificar tu correo primero";
        return;
      }

      status.innerText = "Registrando empresa...";

      const res = await fetch(
        "https://n8n.globalnexoshop.com/webhook/registro",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datosEmpresa)
        }
      );

      const data = await res.json();

      if (!data.ok) {
        status.innerText = data.error || "Error registrando la empresa";
        return;
      }

      // üîê GUARDAMOS SOLO EL NIT (dato puente)
      sessionStorage.setItem("empresa_nit", datosEmpresa.nit);

      window.location.href = "/Plataforma_Restaurantes/registro/usuario.html";
    });
  </script>
</body>
</html>
